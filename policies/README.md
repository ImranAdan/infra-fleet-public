# Kyverno Policies

This directory contains Kyverno policies for validating Kubernetes manifests in CI before they reach the cluster.

## How It Works

Policies are validated in two places:

1. **CI (Shift-Left)**: The `gitops-validate` workflow runs `kyverno apply` against manifests in `k8s/applications/` before merge
2. **Cluster (Runtime)**: When Kyverno is deployed to the cluster, it acts as an admission controller enforcing policies on all resources

## Current Policies

| Policy | Severity | Description |
|--------|----------|-------------|
| `block-default-namespace` | Medium | Prevents deployments to the `default` namespace |
| `block-latest-tag` | Medium | Requires explicit image tags (no `:latest`) |
| `require-ecr-images` | High | Requires ECR images in `applications` namespace |

## Scope & Limitations

### What Gets Validated

- **Application manifests** in `k8s/applications/` - Direct Deployment, Pod, StatefulSet, DaemonSet, Job, CronJob resources

### What Does NOT Get Validated

- **Flux CRDs** (HelmRelease, Kustomization, ImagePolicy, etc.) - These are orchestration resources, not workloads
- **Helm chart contents** - Charts are external; their Deployments are generated at runtime
- **Infrastructure namespaces** - `kube-system`, `flux-system`, `observability` are excluded from `require-ecr-images`

### Why This Scope?

```
k8s/
├── applications/          <-- VALIDATED (actual workload manifests)
│   └── load-harness/
│       ├── deployment.yaml   ✓ Checked by policies
│       ├── service.yaml      (skipped - not a workload)
│       └── ingress.yaml      (skipped - not a workload)
├── infrastructure/        <-- NOT VALIDATED (Flux CRDs)
│   ├── aws-load-balancer-controller/
│   │   └── helmrelease.yaml  (HelmRelease - not a workload)
│   └── observability/
│       └── kube-prometheus-stack.yaml  (HelmRelease)
└── flux-system/           <-- NOT VALIDATED (Flux internals)
```

Flux CRDs like `HelmRelease` only *reference* Helm charts - they don't contain Pod specs. The actual Deployments are:
1. Defined inside the Helm chart (external repo)
2. Generated by Helm at deployment time
3. Validated by Kyverno in-cluster (if deployed)

## Adding New Policies

1. Create a new `.yaml` file in this directory
2. Use `apiVersion: kyverno.io/v1` and `kind: ClusterPolicy`
3. Target resource kinds: `Pod`, `Deployment`, `StatefulSet`, `DaemonSet`, `Job`, `CronJob`
4. For Deployments, use `anyPattern` to match both:
   - `spec.containers` (for Pods)
   - `spec.template.spec.containers` (for Deployments/StatefulSets)

Example structure:
```yaml
spec:
  validationFailureAction: Enforce
  rules:
    - name: my-rule
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
      validate:
        message: "Validation failed"
        anyPattern:
          - spec:
              containers:
                - image: "pattern-here"
          - spec:
              template:
                spec:
                  containers:
                    - image: "pattern-here"
```

## CI Output

The `k8s-manifest-validate` workflow displays a table showing each policy evaluation:

```
│ ID │ POLICY                  │ RULE                    │ RESOURCE                              │ RESULT │ REASON │
│ 1  │ block-default-namespace │ block-default-namespace │ applications/Deployment/load-harness  │ Pass   │        │
│ 2  │ block-latest-tag        │ block-latest-tag        │ applications/Deployment/load-harness  │ Pass   │        │
│ 3  │ require-ecr-images      │ require-ecr-images      │ applications/Deployment/load-harness  │ Pass   │        │
```

- **POLICY**: The ClusterPolicy being evaluated
- **RULE**: The specific rule within the policy
- **RESOURCE**: namespace/kind/name of the resource
- **RESULT**: Pass, Fail, or Skip
- **REASON**: Failure message (if applicable)

## Testing Policies Locally

```bash
# Test a single file
docker run --rm -v "$(pwd)":/workspace -w /workspace \
  ghcr.io/kyverno/kyverno-cli:v1.13.4 \
  apply policies/ --resource k8s/applications/load-harness/deployment.yaml

# Test multiple files (note: each file needs --resource flag)
docker run --rm -v "$(pwd)":/workspace -w /workspace \
  ghcr.io/kyverno/kyverno-cli:v1.13.4 \
  apply policies/ \
  --resource k8s/applications/load-harness/deployment.yaml \
  --resource k8s/applications/load-harness/service.yaml \
  --table
```

## References

- [Kyverno Documentation](https://kyverno.io/docs/)
- [Kyverno Policy Library](https://kyverno.io/policies/)
- [Kyverno CLI](https://kyverno.io/docs/kyverno-cli/)
- [Release Engineering Roadmap](../docs/RELEASE-ENGINEERING-ROADMAP.md) - Phase 2 context
- [GitOps Setup Guide](../docs/GITOPS-SETUP.md) - How GitOps validation fits in
